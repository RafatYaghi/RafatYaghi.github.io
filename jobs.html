<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Evaluator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #F2F2F7;
            color: #1C1C1E;
            line-height: 1.5;
            padding-top: env(safe-area-inset-top);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1rem;
            color: #8E8E93;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .input-group {
            margin-bottom: 24px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .label {
            display: block;
            font-size: 1rem;
            font-weight: 500;
            color: #1C1C1E;
            margin-bottom: 8px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            width: 100%;
            padding: 16px;
            border: 2px dashed #C7C7CC;
            border-radius: 12px;
            background: #F2F2F7;
            font-size: 1rem;
            color: #1C1C1E;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input:hover {
            border-color: #007AFF;
            background: #F0F8FF;
        }

        .file-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 1px solid #C7C7CC;
            border-radius: 12px;
            font-size: 1rem;
            color: #1C1C1E;
            background: white;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .textarea:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .textarea::placeholder {
            color: #8E8E93;
        }

        .evaluate-btn {
            width: 100%;
            padding: 16px 24px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: scale(1);
        }

        .evaluate-btn:hover {
            background: #0056CC;
        }

        .evaluate-btn:active {
            transform: scale(0.95);
        }

        .evaluate-btn:disabled {
            background: #C7C7CC;
            cursor: not-allowed;
            transform: scale(1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 24px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #C7C7CC;
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .results {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .results.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .match-score {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .match-score h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .match-score p {
            font-size: 1.125rem;
            opacity: 0.9;
        }

        .verdict {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            margin-top: 8px;
        }

        .verdict.excellent { background: #34C759; color: white; }
        .verdict.good { background: #FF9500; color: white; }
        .verdict.partial { background: #FFCC00; color: #1C1C1E; }
        .verdict.poor { background: #FF3B30; color: white; }

        .results-content {
            font-size: 1rem;
            line-height: 1.6;
        }

        .results-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 24px 0 16px 0;
            color: #1C1C1E;
        }

        .results-content h3:first-child {
            margin-top: 0;
        }

        .results-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 0.95rem;
        }

        .results-content th,
        .results-content td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E5E5EA;
        }

        .results-content th {
            background: #F2F2F7;
            font-weight: 600;
            color: #1C1C1E;
        }

        .results-content tr:last-child td {
            border-bottom: none;
        }

        .results-content ul {
            padding-left: 20px;
            margin: 16px 0;
        }

        .results-content li {
            margin: 8px 0;
            color: #3C3C43;
        }

        .results-content code {
            background: #F2F2F7;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: SF Mono, Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.9em;
        }

        .error {
            background: #FF3B30;
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        .api-key-input {
            width: 100%;
            padding: 16px;
            border: 1px solid #C7C7CC;
            border-radius: 12px;
            font-size: 1rem;
            color: #1C1C1E;
            background: white;
            font-family: inherit;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .match-score h2 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CV Evaluator & Job Search</h1>
            <p>Upload a CV, search jobs via Greenhouse, and get match analyses</p>
        </div>

        <div class="card">
            <div class="input-group">
                <label class="label" for="apiKey">OpenAI API Key</label>
                <input type="password" id="apiKey" class="api-key-input" placeholder="Enter your OpenAI API key" />
            </div>

            <div class="input-group">
                <label class="label" for="cvFile">Upload CV (PDF)</label>
                <input type="file" id="cvFile" class="file-input" accept="application/pdf" />
            </div>

            <div class="input-group">
                <label class="label" for="greenhouseCompany">Greenhouse Board Slug</label>
                <input type="text" id="greenhouseCompany" class="textarea" placeholder="e.g. yourcompany" />
            </div>
            <div class="input-group">
                <label class="label" for="jobTitles">Job Titles (comma-separated)</label>
                <input type="text" id="jobTitles" class="textarea" placeholder="e.g. Software Engineer, Backend Developer" />
            </div>
            <div class="input-group">
                <label class="label" for="locationFilter">Location Filter</label>
                <input type="text" id="locationFilter" class="textarea" placeholder="e.g. London, Remote" />
            </div>

            <button id="evaluateBtn" class="evaluate-btn">Search & Evaluate Jobs</button>
        </div>

        <div class="error" id="errorMsg"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Working...</p>
        </div>
        <div class="results" id="results">
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const elements = {
            apiKey: document.getElementById('apiKey'),
            cvFile: document.getElementById('cvFile'),
            greenhouseCompany: document.getElementById('greenhouseCompany'),
            jobTitles: document.getElementById('jobTitles'),
            locationFilter: document.getElementById('locationFilter'),
            evaluateBtn: document.getElementById('evaluateBtn'),
            loading: document.getElementById('loading'),
            results: document.getElementById('results'),
            errorMsg: document.getElementById('errorMsg'),
            resultsContent: document.getElementById('resultsContent')
        };

        async function extractTextFromPDF(file) {
            const buf = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(buf).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            return text;
        }

        async function fetchGreenhouseJobs(board, titles, location) {
            const res = await fetch(`https://boards-api.greenhouse.io/v1/boards/${board}/jobs?content=true`);

            if (!res.ok) throw new Error('Greenhouse API error');
            const data = await res.json();
            return data.jobs
                .filter(job => titles.some(t => job.title.toLowerCase().includes(t.toLowerCase())))
                .filter(job => !location || job.location.name.toLowerCase().includes(location.toLowerCase()));
        }

        // Call ChatGPT API
        async function callChatGPT(cvText, jobDesc, apiKey) {
            const prompt = `You are a strict, objective evaluator for matching a candidate's CV to a job description (JD).   
You must assess how well the CV matches the explicit requirements and responsibilities of the JD. 

### Task: 
1️⃣ Analyze the JD and extract **5–10 key skill/requirement categories**, based on what is clearly stated in the JD.   
2️⃣ Assign an estimated **weight (%)** to each category, reflecting its importance in the JD (weights must sum to 100).   
3️⃣ For each category, review the CV and assign a **score from 0–10**, based ONLY on evidence explicitly present in the CV. If the skill or experience is not mentioned explicitly, score it as 0.   
4️⃣ Compute the weighted score for each category: (score / 10) × weight.   
5️⃣ Sum all weighted scores to get the **final match percentage (0–100)**. 
6 Analyise what else do i need to excle at this job if I applied . 

### Instructions: 
- Do NOT assume anything not written in the CV. 
- Do NOT give credit for "potential" — base your judgment strictly on explicit statements. 
- Be harsh: if a critical skill is missing, score it 0. 
- Present the result in a clean markdown table. 

### Output Format: 
1️⃣ **Extracted Categories & Weights**   
| Category | Weight (%) | 
|----------|------------| 
| …        | …          | 

2️⃣ **Scoring Table**   
| Category | Weight (%) | Score (0–10) | Weighted Score | 
|----------|------------|---------------|----------------| 
| …        | …          | …             | …              | 

3️⃣ **Final Results**   
- Raw Total Score (0–10):   
- Final Match Percentage (0–100):   
- Verdict:   
  - >80: Excellent Fit   
  - 60–80: Good Fit   
  - 40–60: Partial Fit   
  - <40: Poor Fit 

4️⃣ **Evidence:**   
List bullet‑points of explicit CV lines or phrases that justify each score. 

6 **Whats next :**   
List bullet‑points of Analyise what else do i need to excle at this job if I applied give a link to each poiunt of where to learn that like coure of book but make sure to include a link ( this is yuor advice to me as cadidste to improve my skills )  . 

Here is the Job Description: 
${jobDesc}

Here is the CV (extracted from PDF): 
${cvText}

Now perform the evaluation.`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.3
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Convert markdown to HTML
        function markdownToHtml(markdown) {
    // Start with the raw markdown
    let html = markdown;

    // Convert headers (###, ##, #) to <h3>
    html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gm, '<h3>$1</h3>');
    html = html.replace(/^# (.*$)/gm, '<h3>$1</h3>');

    // Convert bold text **bold**
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // Convert markdown tables
    // Matches:
    //  \n|Head1|Head2|\n|-----|-----|\n|Row1|Row2|\n...
    html = html.replace(
      /\n\|(.+)\|\n\|[-\s|]+\|\n((?:\|.+\|\n?)*)/g,
      (match, headerLine, rowsBlock) => {
        // headers
        const headers = headerLine
          .split('|')
          .map(cell => `<th>${cell.trim()}</th>`)
          .join('');
        // rows
        const rows = rowsBlock
          .split('\n')
          .filter(r => r.trim())
          .map(row => {
            const cols = row
              .split('|')
              .map(cell => `<td>${cell.trim()}</td>`)
              .join('');
            return `<tr>${cols}</tr>`;
          })
          .join('');
        return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
      }
    );

    // Convert bullet points (“- item”) into <ul><li>…</li></ul>
    html = html.replace(/^\- (.+)$/gm, '<li>$1</li>');
    // Wrap consecutive <li>...</li> with <ul>…</ul>
    html = html.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');

    // Convert double newlines into paragraph breaks
    html = html
      .replace(/\n\n/g, '</p><p>')   // blank line → </p><p>
      .replace(/^/, '<p>')           // start → <p>
      .replace(/$/, '</p>');         // end → </p>

    // Clean up empty paragraphs
    html = html.replace(/<p><\/p>/g, '');

    // Avoid wrapping block elements in <p>
    html = html.replace(/<p>(<h3>)/g, '$1');
    html = html.replace(/(<\/h3>)<\/p>/g, '$1');
    html = html.replace(/<p>(<table>)/g, '$1');
    html = html.replace(/(<\/table>)<\/p>/g, '$1');
    html = html.replace(/<p>(<ul>)/g, '$1');
    html = html.replace(/(<\/ul>)<\/p>/g, '$1');

    return html;
}

 function extractMatchPercentage(resp) {
            const m = resp.match(/Final Match Percentage[^:]*:\s*(\d+(?:\.\d+)?)/i);
            return m ? parseFloat(m[1]) : 0;
        }

        async function evaluateCV() {
            elements.errorMsg.classList.remove('show');
            if (!elements.apiKey.value || !elements.cvFile.files[0]) { elements.errorMsg.textContent = 'API key and CV PDF are required'; elements.errorMsg.classList.add('show'); return; }

            elements.evaluateBtn.disabled = true;
            elements.loading.classList.add('show');
            elements.results.classList.remove('show');
            elements.resultsContent.innerHTML = '';
            try {
                const cvText = await extractTextFromPDF(elements.cvFile.files[0]);
                const board = elements.greenhouseCompany.value.trim();
                const titles = elements.jobTitles.value.split(',').map(s => s.trim()).filter(Boolean);
                const loc = elements.locationFilter.value.trim();

                if (board && titles.length) {
                    const jobs = await fetchGreenhouseJobs(board, titles, loc);
                  
const jobs1 = jobs.slice(0, 2);
                                        console.log(jobs1.length )

                    if (!jobs1.length) throw new Error('No jobs found with given filters');

                    for (let job of jobs1) {
                        const res = await callChatGPT(cvText, job.content || job.description || job.absolute_url, elements.apiKey.value);
                        const score = extractMatchPercentage(res);
                        const html = `
                          <div class="card">
                            <a href="https://logo.dev" alt="Logo API">Logos provided by Logo.dev</a>
                            <div class="match-score"><h2>${Math.round(score)}%</h2><p>${job.title}</p></div>
                            <div class="results-content">${markdownToHtml(res)}</div>
                          </div>
                        `;
                        elements.resultsContent.innerHTML += html;
                    }
                } else {
                    elements.errorMsg.textContent = 'Provide a Greenhouse board slug and at least one job title';
                    elements.errorMsg.classList.add('show');
                }

                elements.loading.classList.remove('show');
                elements.results.classList.add('show');
            } catch (err) {
                elements.errorMsg.textContent = err.message;
                elements.errorMsg.classList.add('show');
                elements.loading.classList.remove('show');
            } finally {
                elements.evaluateBtn.disabled = false;
            }
        }
        elements.evaluateBtn.addEventListener('click', evaluateCV);
    </script>
</body>
</html>
