<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“‹ Tasks on Segments Grid</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  body {
    margin: 0;
    height: 100vh;
    background: #f7f7f7;
    font-family: Arial, sans-serif;
    overflow: hidden;
    position: relative;
  }

  #progress {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap: 2px;
    z-index: 0;
    padding: 5px;
    box-sizing: border-box;
  }

  .segment {
    background: transparent;
    transition: background 0.3s;
    position: relative;
    overflow: hidden;
    font-size: 0.7rem;
    color: #222;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .segment .task {
    background: rgba(255,255,255,0.8);
    padding: 2px 4px;
    margin: 1px 0;
    border-radius: 3px;
    text-align: center;
  }

  #clock-container {
    position: relative;
    z-index: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  #clock {
    font-size: 10vw;
    font-weight: 900;
    color: #333;
    display: flex;
    gap: 0.3em;
    line-height: 1;
  }

  .seconds {
    color: #888;
  }

  button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 1rem;
    cursor: pointer;
    z-index: 2;
  }

  #date {
    position: absolute;
    bottom: 20px;
    font-size: 1.2rem;
    color: #555;
  }

  .task input {
    margin-right: 4px;
  }
</style>
</head>
<body>

<div id="progress"></div>

<div id="clock-container">
  <div id="clock"></div>
  <button id="fullscreen">Toggle Fullscreen</button>
  <div id="date"></div>
</div>

<script>
const sheetId = prompt("Enter your Google Sheet ID:");
const clientId = prompt("Enter your Google OAuth Client ID:");
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
const RANGE = 'Sheet1!A2:D';
let accessToken = null;

const clock = document.getElementById('clock');
const dateDiv = document.getElementById('date');
const btn = document.getElementById('fullscreen');
const progress = document.getElementById('progress');
const segments = [];

const todayStr = new Date().toISOString().split('T')[0];

for (let i = 0; i < 48; i++) {
  const seg = document.createElement('div');
  seg.className = 'segment';
  progress.appendChild(seg);
  segments.push(seg);
}

function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');

  clock.innerHTML = `
    <span>${h}</span><span>:</span><span>${m}</span><span>:</span><span class="seconds">${s}</span>
  `;

  const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  dateDiv.textContent = now.toLocaleDateString(undefined, dateOptions);
}

updateClock();
setInterval(updateClock, 1000);

btn.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
});

document.addEventListener('fullscreenchange', () => {
  btn.style.display = document.fullscreenElement ? 'none' : 'inline-block';
});

function initOAuth() {
  google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope: SCOPES,
    callback: (resp) => {
      accessToken = resp.access_token;
      loadTasks();
    }
  }).requestAccessToken();
}

function clearSegments() {
  segments.forEach(seg => {
    seg.innerHTML = '';
    seg.style.background = 'transparent';
  });
}

function loadTasks() {
  fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${RANGE}`, {
    headers: { Authorization: `Bearer ${accessToken}` }
  })
  .then(res => res.json())
  .then(data => {
    clearSegments();
    const rows = data.values || [];

    rows.forEach((row, idx) => {
      const [name, status, createdAt] = row;
      if (!createdAt) return;

      const createdDate = createdAt.split(' ')[0];
      if (createdDate !== todayStr) return;

      const [hour, minute] = createdAt.split(' ')[1].split(':');
      const totalMinutes = parseInt(hour) * 60 + parseInt(minute);
      const segmentIndex = Math.floor(totalMinutes / 30);

      const taskDiv = document.createElement('div');
      taskDiv.className = 'task';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = status === 'âœ…';
      checkbox.onchange = () => updateTask(idx + 2, checkbox.checked ? 'âœ…' : 'âŒ');
      taskDiv.appendChild(checkbox);
      taskDiv.append(name);
      segments[segmentIndex].appendChild(taskDiv);
      segments[segmentIndex].style.background = 'rgba(255, 0, 0, 0.05)';
    });
  });
}

function updateTask(rowNumber, status) {
  const timestamp = status === 'âœ…' ? new Date().toISOString().replace('T',' ').substring(0,19) : '';

  // fetch existing Created At
  fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!C${rowNumber}:C${rowNumber}`, {
    headers: { Authorization: `Bearer ${accessToken}` }
  })
  .then(res => res.json())
  .then(data => {
    const createdAt = (data.values && data.values[0] && data.values[0][0]) || '';
    const body = { values: [[status, createdAt, timestamp]] };

    return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!B${rowNumber}:D${rowNumber}?valueInputOption=RAW`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
  })
  .then(() => loadTasks())
  .catch(err => console.error(err));
}

initOAuth();
setInterval(loadTasks, 60 * 1000); // refresh every minute
</script>

</body>
</html>
