<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìã Tasks Grid + Clock + Dark Mode + Next Tasks</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  height: 100vh;
  overflow: hidden;
  background: #f7f7f7;
  color: #222;
  transition: background 0.3s, color 0.3s;
}
body.dark {
  background: #222;
  color: #ddd;
}

/* Modal */
.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(12px);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  z-index: 20;
  text-align: center;
  display: none;
}
body.dark .modal {
  background: rgba(34,34,34,0.95);
}
.modal.show {
  display: block;
}
.modal input {
  margin: 10px 0;
  padding: 8px;
  width: 80%;
  border-radius: 6px;
  border: 1px solid #ccc;
}
.modal button {
  margin-top: 10px;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: #007ACC;
  color: white;
  cursor: pointer;
}
.modal button:hover {
  background: #005f99;
}

/* Clock */
#clock-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
#clock {
  font-size: 8vw;
  font-weight: bold;
}
#date {
  margin-top: 10px;
}

/* Segments */
#progress {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  grid-template-rows: repeat(6, 1fr);
  gap: 2px;
  z-index: -1;
  padding: 5px;
}
.segment {
  background: transparent;
  font-size: 0.7rem;
  padding: 2px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}
.task {
  background: rgba(255,255,255,0.8);
  margin: 2px 0;
  padding: 2px 4px;
  border-radius: 4px;
  font-size: 0.65rem;
  display: flex;
  gap: 4px;
}
body.dark .task {
  background: rgba(50,50,50,0.8);
}

/* Next tasks */
#next-tasks {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px);
  border-radius: 8px;
  padding: 10px;
  min-width: 220px;
  max-width: 300px;
  z-index: 3;
  text-align: left;
}
body.dark #next-tasks {
  background: rgba(34,34,34,0.9);
}
#next-tasks h4 {
  margin: 0 0 5px;
  text-align: center;
  font-size: 0.9rem;
}
#next-tasks-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.next-task-item {
  background: rgba(255,255,255,0.8);
  border-radius: 4px;
  padding: 2px 4px;
  font-size: 0.75rem;
}
body.dark .next-task-item {
  background: rgba(50,50,50,0.8);
}

/* Controls */
#controls {
  position: absolute;
  top: 0;
  right: 0;
  display: flex;
  gap: 6px;
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(6px);
  padding: 6px;
  border-bottom-left-radius: 8px;
  z-index: 3;
}
body.dark #controls {
  background: rgba(0,0,0,0.7);
}
#controls button {
  border: none;
  background: rgba(0,0,0,0.1);
  color: #333;
  padding: 4px 6px;
  border-radius: 4px;
  cursor: pointer;
}
body.dark #controls button {
  color: #ddd;
}
#stopwatch {
  position: absolute;
  bottom: 10px;
  left: 10px;
  background: rgba(255,255,255,0.9);
  border-radius: 6px;
  padding: 6px;
}
body.dark #stopwatch {
  background: rgba(34,34,34,0.9);
}
</style>
</head>
<body>

<div id="credentials-modal" class="modal show">
  <h3>üîó Connect to Google Sheets</h3>
  <input type="text" id="clientIdInput" placeholder="Google OAuth Client ID">
  <input type="text" id="sheetIdInput" placeholder="Google Sheet ID">
  <button id="connectBtn">‚úÖ Connect</button>
</div>

<div id="progress"></div>

<div id="clock-container">
  <div id="clock"></div>
  <div id="date"></div>
</div>

<div id="controls">
  <button id="darkModeBtn">üåô Dark</button>
</div>

<div id="stopwatch">
  ‚è± 00:00:00
  <button id="startStopBtn">‚ñ∂Ô∏è Start</button>
  <button id="resetBtn">üîÑ Reset</button>
</div>

<div id="next-tasks">
  <h4>Next Tasks</h4>
  <div id="next-tasks-list"></div>
</div>

<script>
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
const RANGE = 'Sheet1!A2:D';
let accessToken = null, clientId = '', sheetId = '', tokenClient;

const clock = document.getElementById('clock');
const dateDiv = document.getElementById('date');
const segments = [];
const progress = document.getElementById('progress');

const credentialsModal = document.getElementById('credentials-modal');
const connectBtn = document.getElementById('connectBtn');
const clientIdInput = document.getElementById('clientIdInput');
const sheetIdInput = document.getElementById('sheetIdInput');
const nextTasksList = document.getElementById('next-tasks-list');

// init segments
for (let i = 0; i < 48; i++) {
  const seg = document.createElement('div');
  seg.className = 'segment';
  progress.appendChild(seg);
  segments.push(seg);
}

if (localStorage.clientId && localStorage.sheetId) {
  clientIdInput.value = localStorage.clientId;
  sheetIdInput.value = localStorage.sheetId;
  initOAuth();
} else {
  credentialsModal.classList.add('show');
}

connectBtn.onclick = () => {
  clientId = clientIdInput.value.trim();
  sheetId = sheetIdInput.value.trim();
  if (!clientId || !sheetId) return alert("Please enter both IDs");
  localStorage.clientId = clientId;
  localStorage.sheetId = sheetId;
  credentialsModal.classList.remove('show');
  initOAuth();
};

function initOAuth() {
  clientId = localStorage.clientId;
  sheetId = localStorage.sheetId;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope: SCOPES,
    callback: (resp) => {
      accessToken = resp.access_token;
      loadTasks();
      setInterval(loadTasks, 60 * 1000);
    }
  });
  tokenClient.requestAccessToken();
}

// Clock & segments
function updateClock() {
  const now = new Date();
  clock.textContent = now.toLocaleTimeString();
  dateDiv.textContent = now.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });

  const totalMinutes = now.getHours() * 60 + now.getMinutes();
  const passedSegments = Math.floor(totalMinutes / 30);
  const progressPercent = (totalMinutes % 30) / 30 * 100;

  segments.forEach((seg, idx) => {
    if (idx < passedSegments) seg.style.background = 'rgba(0,255,0,0.2)';
    else if (idx === passedSegments) seg.style.background = `linear-gradient(to right, rgba(0,255,0,0.3) ${progressPercent}%, transparent 0%)`;
    else seg.style.background = 'transparent';
  });
}
setInterval(updateClock, 1000);
updateClock();

function clearSegments() {
  segments.forEach(seg => seg.innerHTML = '');
}

// Load tasks
function loadTasks() {
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const nowMinutes = now.getHours() * 60 + now.getMinutes();
  clearSegments();
  nextTasksList.innerHTML = '';

  fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${RANGE}`, {
    headers: { Authorization: `Bearer ${accessToken}` }
  })
  .then(res => res.json())
  .then(data => {
    const rows = data.values || [];
    const upcoming = [];

    rows.forEach((row, idx) => {
      const [name, status, createdAt] = row;
      if (!name || !createdAt) return;
      const [datePart, timePart] = createdAt.split(' ');
      if (datePart !== today) return;

      const [hour, minute] = timePart.split(':').map(Number);
      const minutes = hour * 60 + minute;
      const segIdx = Math.floor(minutes / 30);

      const div = document.createElement('div');
      div.className = 'task';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = status === '‚úÖ';
      cb.onchange = () => updateTask(idx + 2, cb.checked ? '‚úÖ' : '‚ùå');
      div.appendChild(cb);
      div.append(name);

      segments[segIdx]?.appendChild(div);

      if (minutes > nowMinutes) {
        upcoming.push({name, time: `${String(hour).padStart(2,0)}:${String(minute).padStart(2,0)}`, minutes});
      }
    });

    upcoming.sort((a,b) => a.minutes-b.minutes);
    if (upcoming.length === 0) {
      nextTasksList.innerHTML = `<div class="next-task-item">üéâ No upcoming tasks</div>`;
    } else {
      upcoming.slice(0,3).forEach(task => {
        const div = document.createElement('div');
        div.className = 'next-task-item';
        div.textContent = `${task.time} ‚Äî ${task.name}`;
        nextTasksList.appendChild(div);
      });
    }
  });
}

function updateTask(rowNumber, status) {
  fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!C${rowNumber}:C${rowNumber}`, {
    headers: { Authorization: `Bearer ${accessToken}` }
  })
  .then(res => res.json())
  .then(data => {
    const createdAt = data.values?.[0]?.[0] || '';
    const body = { values: [[status, createdAt, new Date().toISOString()]] };
    return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!B${rowNumber}:D${rowNumber}?valueInputOption=RAW`, {
      method: 'PUT',
      headers: {'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
  })
  .then(() => loadTasks());
}

// Dark Mode
document.getElementById('darkModeBtn').onclick = () => document.body.classList.toggle('dark');

// Stopwatch
const stopwatchEl = document.getElementById('stopwatch');
const startStopBtn = document.getElementById('startStopBtn');
const resetBtn = document.getElementById('resetBtn');
let stopwatchInterval = null, elapsed = 0, running = false;
startStopBtn.onclick = () => {
  if (!running) {
    running = true;
    startStopBtn.textContent = '‚è∏Ô∏è Pause';
    stopwatchInterval = setInterval(() => {
      elapsed++;
      updateStopwatch();
    },1000);
  } else {
    running = false;
    clearInterval(stopwatchInterval);
    startStopBtn.textContent = '‚ñ∂Ô∏è Start';
  }
};
resetBtn.onclick = () => {
  elapsed = 0;
  running = false;
  clearInterval(stopwatchInterval);
  updateStopwatch();
  startStopBtn.textContent = '‚ñ∂Ô∏è Start';
};
function updateStopwatch() {
  const h = String(Math.floor(elapsed/3600)).padStart(2,0);
  const m = String(Math.floor(elapsed/60)%60).padStart(2,0);
  const s = String(elapsed%60).padStart(2,0);
  stopwatchEl.childNodes[0].textContent = `‚è± ${h}:${m}:${s}`;
}
updateStopwatch();
</script>
</body>
</html>
